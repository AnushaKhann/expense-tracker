{% extends "base.html" %}

{% block title %}{{ t.timeline.title }} - {{ t.app_name }}{% endblock %}

{% block content %}
<h1>{{ t.timeline.title }}</h1>
<div id="timelineMessages"></div>
<div id="timelineContainer">
    <p>{{ t.timeline.loading }}</p>
</div>
<div class="pagination mt-2">
    <button id="prevPageBtn" onclick="loadPage('prev')" style="display:none;" class="button secondary">{{ t.timeline.previous }}</button>
    <span id="pageInfo"></span>
    <button id="nextPageBtn" onclick="loadPage('next')" style="display:none;" class="button secondary">{{ t.timeline.next }}</button>
</div>
{% endblock %}

{% block scripts %}
<script>
    const timelineContainer = document.getElementById('timelineContainer');
    const timelineMessages = document.getElementById('timelineMessages');
    const prevPageBtn = document.getElementById('prevPageBtn');
    const nextPageBtn = document.getElementById('nextPageBtn');
    const pageInfoSpan = document.getElementById('pageInfo');

    let currentPage = 1;
    const perPage = 10;

    // Translations
    const t = {
        loading: "{{ t.timeline.loading }}",
        noExpenses: "{{ t.timeline.no_expenses }}",
        page: "{{ t.timeline.page }}",
        of: "{{ t.timeline.of }}",
        felt: "{{ t.timeline.felt }}",
        date: "{{ t.home.date }}",
        description: "{{ t.home.description }}",
        amount: "{{ t.home.amount }}",
        category: "{{ t.home.category }}",
        merchant: "{{ t.home.merchant }}",
        edit: "{{ t.home.edit }}",
        delete: "{{ t.home.delete }}",
        deleteConfirm: "{{ t.home.delete_confirm }}"
    }; 

    function displayTimelineMessage(message, type = 'info') {
        timelineMessages.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        setTimeout(() => { timelineMessages.innerHTML = ''; }, 5000);
    }

    async function fetchExpensesForTimeline(page) {
        timelineContainer.innerHTML = `<p>${t.loading}</p>`; 
        try {
            // Use url_for for the base API endpoint, then add query parameters
            const baseApiUrl = "{{ url_for('expenses_timeline_api') }}";
            const response = await fetch(`${baseApiUrl}?page=${page}&per_page=${perPage}`);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            
            if ((!data.expenses || data.expenses.length === 0) && page === 1) {
                timelineContainer.innerHTML = `<p>${t.noExpenses}</p>`;
                prevPageBtn.style.display = 'none';
                nextPageBtn.style.display = 'none';
                pageInfoSpan.textContent = '';
                return;
            } else if ((!data.expenses || data.expenses.length === 0) && page > 1) {
                 displayTimelineMessage('No more expenses to load.', 'info');
                 currentPage = data.current_page > 0 ? data.current_page : 1; 
                 nextPageBtn.style.display = 'none'; 
                 prevPageBtn.style.display = data.has_prev ? 'inline-block' : 'none';
                 pageInfoSpan.textContent = `Page ${currentPage} of ${data.total_pages}`;
                 if(timelineContainer.querySelectorAll('.card').length === 0){ 
                    timelineContainer.innerHTML = '<p>No expenses on this page.</p>';
                 }
                 return;
            }

            let html = '';
            data.expenses.forEach(exp => {
                const emotionIcons = {
                    happy: '<i class="fas fa-smile" style="color: #48bb78;"></i>',
                    neutral: '<i class="fas fa-meh" style="color: #718096;"></i>',
                    sad: '<i class="fas fa-frown" style="color: #fc8181;"></i>',
                    stressed: '<i class="fas fa-tired" style="color: #f6ad55;"></i>',
                    excited: '<i class="fas fa-star" style="color: #f6ad55;"></i>',
                    regretful: '<i class="fas fa-face-frown-open" style="color: #fc8181;"></i>',
                    necessary: '<i class="fas fa-check-circle" style="color: #48bb78;"></i>',
                    motivated: '<i class="fas fa-fire" style="color: #ed64a6;"></i>'
                };
                // Ensure date string is correctly parsed, add T00:00:00 for local interpretation
                const expenseDate = exp.date ? new Date(exp.date + 'T00:00:00').toLocaleDateString() : 'N/A';
                const editUrl = `/edit_expense/${exp.id}`;
                const deleteUrl = `/delete_expense/${exp.id}`;

                html += `
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <p><strong>${t.date}:</strong> ${expenseDate}</p>
                                <p><strong>${t.description}:</strong> ${exp.description || 'N/A'}</p>
                                <p><strong>${t.amount}:</strong> â‚¹${exp.amount.toFixed(2)}</p>
                                <p><strong>${t.category}:</strong> ${exp.category || 'Uncategorized'}</p>
                                ${exp.merchant ? `<p><strong>${t.merchant}:</strong> ${exp.merchant}</p>` : ''}
                                ${exp.emotion_tag ? `<p><strong>${t.felt}:</strong> ${emotionIcons[exp.emotion_tag] || ''} ${exp.emotion_tag}</p>` : ''}
                            </div>
                            <div class="kebab-menu" id="timeline-menu-${exp.id}">
                                <button class="kebab-button" onclick="toggleTimelineKebab(${exp.id})" type="button"><i class="fas fa-ellipsis-v"></i></button>
                                <div class="kebab-dropdown">
                                    <a href="${editUrl}"><i class="fas fa-edit"></i> ${t.edit}</a>
                                    <div class="divider"></div>
                                    <form method="POST" action="${deleteUrl}" style="margin: 0;" onsubmit="return confirm('${t.deleteConfirm}');">
                                        <button type="submit" class="delete-option"><i class="fas fa-trash-alt"></i> ${t.delete}</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            timelineContainer.innerHTML = html;

            currentPage = data.current_page;
            pageInfoSpan.textContent = `${t.page} ${currentPage} ${t.of} ${data.total_pages}`;
            prevPageBtn.style.display = data.has_prev ? 'inline-block' : 'none';
            nextPageBtn.style.display = data.has_next ? 'inline-block' : 'none';
            prevPageBtn.disabled = false;
            nextPageBtn.disabled = false;

        } catch (error) {
            console.error('Error fetching expenses for timeline:', error);
            timelineContainer.innerHTML = `<p class="alert alert-danger">Could not load expenses: ${error.message}</p>`;
            prevPageBtn.style.display = 'none';
            nextPageBtn.style.display = 'none';
            pageInfoSpan.textContent = '';
        }
    }

    function loadPage(direction) {
        if (direction === 'next') {
            nextPageBtn.disabled = true; 
            fetchExpensesForTimeline(currentPage + 1);
        } else if (direction === 'prev' && currentPage > 1) {
            prevPageBtn.disabled = true; 
            fetchExpensesForTimeline(currentPage - 1);
        }
    }

    function toggleTimelineKebab(expenseId) {
        const menu = document.getElementById(`timeline-menu-${expenseId}`);
        const allMenus = document.querySelectorAll('.kebab-menu');
        
        // Close all other menus
        allMenus.forEach(m => {
            if (m.id !== `timeline-menu-${expenseId}`) {
                m.classList.remove('active');
            }
        });
        
        // Toggle current menu
        menu.classList.toggle('active');
    }

    // Close kebab menu when clicking outside
    document.addEventListener('click', (event) => {
        if (!event.target.closest('.kebab-menu')) {
            document.querySelectorAll('.kebab-menu').forEach(menu => {
                menu.classList.remove('active');
            });
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        if (document.getElementById('timelineContainer')) { // Only run if on timeline page
             fetchExpensesForTimeline(currentPage);
        }
    });
</script>
{% endblock %}